function getSmallestRectangleCoordinates(a){var b=[],c=[];return a.forEach(function(a,d){var e=!1;a.forEach(function(a,b){a.opacity&&(e=!0,c.push(b))}),e&&b.push(d)}),{x1:arrayMin(c),y1:arrayMin(b),x2:arrayMax(c),y2:arrayMax(b)}}function getSmallestMatrix(a){var b=getSmallestRectangleCoordinates(a);return getMatrixExtract(b.x1,b.y1,b.x2,b.y2,a)}function getMatrixExtract(a,b,c,d,e){var f=[];return e.slice(b,d+1).forEach(function(b,d){f.push(b.slice(a,c+1))}),f}function arrayMax(a){var b=a[0];return a.forEach(function(a){b=Math.max(b,a)}),b}function arrayMin(a){var b=a[0];return a.forEach(function(a){b=Math.min(b,a)}),b}function download(a,b){var c=document.createElement("a");if(c.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(b)),c.setAttribute("download",a),document.createEvent){var d=document.createEvent("MouseEvents");d.initEvent("click",!0,!0),c.dispatchEvent(d)}else c.click()}function readUrlAsData(a,b){var c=new FileReader;c.onloadend=function(){b(c.result)},c.readAsDataURL(a)}function readUrlAsText(a,b){var c=new FileReader;c.onloadend=function(){b(c.result)},c.readAsText(a)}function side2Diagonal(a){return Math.sqrt(2*Math.pow(a,2))}function diagonal2Side(a){return Math.sqrt(Math.pow(a,2)/2)}function deepCopy(a){return JSON.parse(JSON.stringify(a))}function Matrix(a){function b(a){for(var b=[],c=0;a>c;++c)b.push(deepCopy(e.baseElement));return b}function c(a){for(var c=0;a>c;++c)e.matrix.push(b(e.matrix.length%2==0?e.matrix[0].length:e.matrix[0].length-1))}function d(a){e.matrix.forEach(function(b){for(var c=0;a>c;++c)b.push(deepCopy(e.baseElement))})}var e=this;this.baseElement={fill:"#000000",opacity:0},this.matrix=a||[[{fill:"#000000",opacity:0}]];var f={extract:function(a,b){return a>e.matrix.length&&c(a-e.matrix.length),b>e.matrix[0].length&&d(b-e.matrix[0].length),getMatrixExtract(0,0,b-1,a-1,e.matrix)},updateCell:function(a,b,c){var a=this.get(a);a.fill=b,a.opacity=c},get:function(a){if(a instanceof SVGElement)return e.matrix[a.parentNode.getAttribute("index")][a.getAttribute("index")];if(a.hasOwnProperty("x")&&a.hasOwnProperty("y"))return e.matrix[a.y][a.x];throw"Invalid cell format"},getMatrix:function(){return e.matrix}};return f}var standardSymbols={"default":[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:0,y:2},{x:1,y:2},{x:2,y:2},{x:3,y:2},{x:0,y:3},{x:1,y:3},{x:2,y:3},{x:0,y:4},{x:1,y:4},{x:2,y:4},{x:3,y:4},{x:0,y:5},{x:1,y:5},{x:2,y:5},{x:0,y:6},{x:1,y:6},{x:2,y:6},{x:3,y:6}],c:[{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:0,y:1},{x:0,y:3},{x:0,y:5},{x:1,y:6},{x:2,y:6},{x:3,y:6}]};xTuilesElement.methods={updateBackgroundImage:function(){readUrlAsData(document.getElementById("background-image").files[0],function(a){document.getElementById("canvas").style.backgroundImage="url("+a+")"})},drawComponents:function(){var a=this.svg.node(),b=this.canvas.node();a.offsetWidth=b.offsetWidth,this.dessiner()},calculerMetriques:function(a,b){a||b||(a=this.nblignes=2*(Math.max(this.hauteur.value,1)-1)+1,b=this.nbcarresligne=Math.max(this.largeur.value,1));var c=this.canvas.node();this.diagonale=Math.min((c.offsetWidth-2)/b,(c.offsetHeight-2)/(a/2+.5)),this.cote=diagonal2Side(this.diagonale),this.decalageRotation=(this.diagonale-this.cote)/2},clear:function(){this.matrix=new Matrix,this.dessiner()},dessiner:function(){this.calculerMetriques(),this.lignes=this.matrix.extract(this.nblignes,this.nbcarresligne),this.resetHandicap(),this.nettoyer(),this.afficher(),this.afficherDecompte()},nettoyer:function(){this.svg.selectAll("g.ligne").remove()},resetHandicap:function(){var a=this.countColors();for(var b in this.couleurs)this.couleurs[b].handicap=this.couleurs[b].compte-(a[b]||0)||0},mouseDown:function(a){"manual"==this.mode?this.changecolor(a):this.setCursor(a.node())},mouseOver:function(a){"manual"==this.mode&&this.sourisenfoncee&&this.changecolor(a)},afficher:function(a,b){a=a||1,b=b||0;var c=this,d=this.svg.selectAll("g.ligne").data(this.lignes).enter().append("g").attr("index",function(a,b){return b}).attr("class","ligne").attr("index",function(a,b){return b}).attr("transform",function(a,b){return b%2===0?"translate(0, "+c.diagonale*b/2+")":"translate("+c.diagonale/2+", "+c.diagonale*b/2+")"});d.selectAll("rect").data(function(a){return a}).enter().append("rect").attr("index",function(a,b){return b}).attr("class","carre").attr("index",function(a,b){return b}).attr("height",this.cote).attr("width",this.cote).attr("x",function(d,e){return e*c.diagonale+c.decalageRotation+Math.floor(e/a)*b}).attr("y",this.decalageRotation).attr("fill-opacity",function(a){return a.opacity}).attr("fill",function(a){return a.fill}).attr("stroke","#424242").attr("stroke-width","1px").on("mousedown",function(){c.mouseDown.call(c,d3.select(this))}).on("mouseover",function(){c.mouseOver.call(c,d3.select(this))})},"export":function(){var a=new Blob([JSON.stringify(this.matrix.getMatrix())],{type:"text/plain;charset=utf-8"});saveAs(a,window.prompt("Nom du fichier: ")+".txt")},pdf:function(){var a=2,b=10,c=this.nbcarresligne/a*b;this.lignes=getSmallestMatrix(this.matrix.getMatrix()),this.calculerMetriques(this.nblignes,this.nbcarresligne+Math.ceil(c/this.diagonale)+1),this.nettoyer(),this.afficher(a,b),saveSvgAsPng(document.getElementById("svg"),"cloture")},loadFile:function(){readUrlAsText(document.getElementById("upload-file").files[0],function(a){this.loadConfiguration(JSON.parse(a))}.bind(this))},loadConfiguration:function(a){this.matrix=new Matrix(a),this.dessiner()},changerCouleur:function(a){this.setSelectedColor(a.currentTarget),"v"==this.sampleDisplay&&"text"==this.mode&&this.toggleVerticalColorSelector()},setSelectedColor:function(a){for(var b=document.querySelectorAll(".container-echantillon-"+this.sampleDisplay+".selected"),c=0;c<b.length;++c)b[c].className="container-echantillon-"+this.sampleDisplay;a.className+=" selected",document.getElementById("active-sample").style.backgroundColor=this.couleur=a.id},ajouterCouleurs:function(a){a.forEach(function(a){this.couleurs[a.code]={compte:0,handicap:0,nom:a.nom,code:a.code}}.bind(this))},afficherDecompte:function(){for(var a in this.couleurs){var b=this.couleurs[a];document.getElementById(b.code+"-counter").innerHTML=b.compte-b.handicap}},changecolor:function(a){var b=this.getCouleur(),c=this.matrix.get(a.node());0==c.opacity&&0==b.opacity||(0==c.opacity&&0!=b.opacity?(a.attr("fill",b.fill),a.attr("fill-opacity",b.opacity),++this.couleurs[b.fill].compte):0!=c.opacity&&0==b.opacity?(--this.couleurs[c.fill].compte,a.attr("fill",b.fill),a.attr("fill-opacity",b.opacity)):(--this.couleurs[c.fill].compte,a.attr("fill",b.fill),a.attr("fill-opacity",b.opacity),++this.couleurs[b.fill].compte),this.matrix.updateCell(a.node(),b.fill,b.opacity),this.menuHidden||this.afficherDecompte())},getCouleur:function(){return{fill:this.couleur,opacity:d3.event.altKey?0:1}},createColorCounter:function(a){var b=document.createElement("li");b.id=a+"-counter-container",b.setAttribute("class","counter-container"),b.innerHTML='<div id="'+a+'-sample" class="sample" style="background-color: '+a+'"></div><div id="'+a+'-counter" class="counter"></div>',document.getElementById("counter-container").appendChild(b)},createPickerSample:function(a,b){var c=document.createElement("div");c.id=a.code,c.setAttribute("class","container-echantillon-"+this.sampleDisplay),c.setAttribute("style","width:"+b+"%;"),c.innerHTML='<div class="echantillon" style="background-color: '+a.code+';"></div>',c.onclick=this.changerCouleur.bind(this),document.getElementById("color-selector-h").appendChild(c),a.element=c},countColors:function(){var a={};return this.lignes.forEach(function(b){b.forEach(function(b){0!=b.opacity&&(a[b.fill]?++a[b.fill]:a[b.fill]=1)})}),a},toggleVerticalColorSelector:function(){var a=document.getElementById("color-selector-v");a.style.display="none"==a.style.display?"block":"none"},toggleMode:function(){var a=document.getElementById("mode-toggler"),b=document.getElementById("color-selector-h"),c=document.getElementById("color-selector-v");if("manual"===this.mode)for(this.mode="text",this.sampleDisplay="v",a.classList.remove("fa-toggle-on"),a.classList.add("fa-toggle-off"),this.showCursor(),document.getElementById("input-text-container").style.display="block",document.getElementById("color-selector-displayer").style.display="block";b.childNodes.length;){var d=b.childNodes[0];d.className="container-echantillon-v",d.style.width="",c.appendChild(d)}else{this.mode="manual",this.sampleDisplay="h",a.classList.remove("fa-toggle-off"),a.classList.add("fa-toggle-on"),this.hideCursor(),document.getElementById("input-text-container").style.display="none",document.getElementById("color-selector-displayer").style.display="none";for(var e=100/Object.keys(this.couleurs).length;c.childNodes.length;){var d=c.childNodes[0];d.style.width=e+"%",d.className="container-echantillon-h",b.appendChild(d)}c.style.display="none"}},toggleMenu:function(){var a=document.getElementById("menu"),b=document.getElementById("conteneur");this.menuHidden?(b.style.left=this.menuWidth,a.style.left="0px"):(b.style.left="0px",a.style.left="-"+this.menuWidth),document.getElementById("conteneur").style.left=document.getElementById("menu").style.width=this.menuHidden?"100px":"0px";for(var c=200;1e3>c;c+=200)window.setTimeout(this.drawComponents.bind(this),c);this.menuHidden=!this.menuHidden},saveSymbol:function(){var a=this.matrix.getMatrix(),b=getSmallestRectangleCoordinates(a),c=getMatrixExtract(b.x1,b.y1,b.x2,b.y2,a),d=[],e=b.y1%2==1;c.forEach(function(a,b){var c=e&&b%2==0?1:0;a.forEach(function(a,e){0!=a.opacity&&d.push({x:e+c,y:b})})});var f=window.prompt("Associer votre dessin a quel caractere");this.symbols[f]=d;var g=document.createElement("div");g.innerHTML=f+" : "+JSON.stringify(d),document.body.appendChild(g)},drawText:function(){if("text"==this.mode&&this.cursorElement){for(var a=document.getElementById("input-text").value,b=0;b<a.length;++b){var c=this.symbols[a[b]]||this.symbols["default"],d=this.cursorElement.getAttribute("index"),e=this.writeSymbol(this.cursorElement.parentNode.getAttribute("index"),d,c);this.setCursor(this.cursorElement.parentNode.childNodes[parseInt(d)+e+2])}this.dessiner()}},writeSymbol:function(a,b,c){var d=1,e=a%2==1;return c.forEach(function(c){d=Math.max(d,c.x);var f=e&&c.y%2==0?0:1;this.matrix.updateCell({x:parseInt(b)+c.x+f,y:parseInt(a)+c.y},this.couleur,c.opacity)}.bind(this)),d},showCursor:function(){this.cursorElement&&this.cursorElement.classList.add("blink")},hideCursor:function(){this.cursorElement&&this.cursorElement.classList.remove("blink")},setCursor:function(a){this.hideCursor(),this.cursorElement=a,this.showCursor()}},xTuilesElement.lifecycle={created:function(){this.carresparpied=4,this.sourisenfoncee=!1,this.couleurs={},this.couleur=null,this.ajouterCouleurs([{nom:"noir",code:"#000000"},{nom:"gris",code:"#97999B"},{nom:"blanc",code:"#FFFFFF"},{nom:"rouge",code:"#BA0C2F"},{nom:"orange",code:"#FE5000"},{nom:"jaune",code:"#FFCD00"},{nom:"vert",code:"#00B140"},{nom:"vert fonce",code:"#006747"},{nom:"bleu",code:"#004B87"},{nom:"cyan",code:"#0085CA"},{nom:"bleu fonce",code:"#002855"}]),this.menuHidden=!0,this.mode="manual",this.menuWidth="150px",this.matrix=new Matrix,this.symbols=standardSymbols,this.sampleDisplay="h",this.hauteur=d3.select("#hauteur").node(),this.largeur=d3.select("#largeur").node(),this.canvas=d3.select("#canvas")},inserted:function(){var a=this.canvas.node();this.svg=this.canvas.append("svg").attr("id","svg").attr("height",a.offsetHeight).attr("width","100%");var b=100/Object.keys(this.couleurs).length;for(var c in this.couleurs)this.createPickerSample(this.couleurs[c],b);for(var c in this.couleurs)this.createColorCounter(this.couleurs[c].code);this.setSelectedColor(this.couleurs[Object.keys(this.couleurs)[0]].element),this.hauteur.onchange=this.dessiner.bind(this),this.largeur.onchange=this.dessiner.bind(this),this.canvas.node().onmousedown=function(){this.sourisenfoncee=!0}.bind(this),this.canvas.node().onmouseup=function(){this.sourisenfoncee=!1}.bind(this),document.getElementById("export").onclick=this["export"].bind(this),document.getElementById("bouton-menu").onclick=this.toggleMenu.bind(this),document.getElementById("open").onclick=function(){document.getElementById("upload-file").click()},document.getElementById("pdf").onclick=this.pdf.bind(this),document.getElementById("open-background-upload").onclick=function(){document.getElementById("background-image").click()},document.getElementById("background-image").onchange=this.updateBackgroundImage.bind(this),document.getElementById("upload-file").onchange=this.loadFile.bind(this),document.getElementById("input-text").onchange=this.drawText.bind(this),document.getElementById("mode-menu").onclick=this.toggleMode.bind(this),document.getElementById("clear").onclick=this.clear.bind(this),document.getElementById("save-symbol").onclick=this.saveSymbol.bind(this),document.getElementById("color-selector-displayer").onclick=this.toggleVerticalColorSelector.bind(this),window.onresize=this.drawComponents.bind(this),this.dessiner()}},xtag.register("x-tuiles",xTuilesElement);